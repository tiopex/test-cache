name: test cache
on:
  push:
  workflow_dispatch:
  workflow_call:

jobs:
  cache-job:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Retrieve ccache arm
        id: retrieve-cache
        uses: actions/cache/restore@v4
        with:
          path: .ccache-arm
          key: ccache-arm-test-${{ github.sha }}
          restore-keys: |
            ccache-arm-test-${{ github.sha }}
            ccache-arm-test-

      - name: Log cache ID
        run: |
          echo "Cache ID: ${{ steps.retrieve-cache.outputs.cache-matched-key }}"
          mkdir -p .ccache-arm
          echo "test" > .ccache-arm/test.txt

      - name: Delete used cache
        if: ${{ steps.retrieve-cache.outputs.cache-hit }}
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install actions/gh-actions-cache
          gh actions-cache delete ${{ steps.retrieve-cache.outputs.cache-matched-key }} -R $GH_REPO --confirm

      - name: save ccache
        uses: actions/cache/save@v4
        with:
          path: .ccache-arm
          key: ccache-arm-test-${{ github.sha }}
#          curl -X DELETE -H "Authorization: Bearer $GH_TOKEN" \
#          -H "Accept: application/vnd.github+json" \
#          https://api.github.com/repos/${{ github.repository }}/actions/caches/${{ steps.retrieve-cache.outputs.cache-matched-key }}
#          gh cache delete ${{ steps.retrieve-cache.outputs.cache-matched-key }}